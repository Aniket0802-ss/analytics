<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GST Analytics Dashboard (Final with ALL Tabs)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* Custom Styles for Inter Font and Chart Sizing */
        body { font-family: 'Inter', sans-serif; }
        .chart-container { position: relative; width: 100%; height: 24rem; }
        
        /* Tailwind-like utility classes for dark mode support */
        .tab-button.active { color: #2563EB; border-color: #2563EB; }
        .kpi-trend-positive { color: #16A34A; }
        .kpi-trend-negative { color: #DC2626; }

        /* Dark Mode Specific Styles */
        .dark .bg-gray-50 { background-color: #1a1a1a; }
        .dark .bg-white { background-color: #2c2c2c; }
        .dark .text-gray-900 { color: #E5E5E5; }
        .dark .text-gray-800 { color: #E5E5E5; }
        .dark .text-gray-700 { color: #A0A0A0; }
        .dark .text-gray-600 { color: #808080; }
        .dark .shadow-lg { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -2px rgba(0, 0, 0, 0.3); }
        .dark .border-gray-200 { border-color: #444; }
        .dark .divide-gray-200 { border-color: #444; }
        .dark .bg-blue-50 { background-color: #3e5066; }
        .dark .text-blue-600 { color: #93C5FD; }
        .dark .text-gray-500 { color: #A0A0A0; }
        
        /* Modal Transition Styles */
        .modal-enter { opacity: 0; transform: scale(0.95); transition: all 300ms ease-out; }
        .modal-enter-active { opacity: 1; transform: scale(1); }
        .modal-leave-active { opacity: 0; transform: scale(0.95); transition: all 300ms ease-in; }

        /* Style for date and select inputs to look clean */
        .filter-input {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-color: white;
            color: #374151;
            padding: 8px;
            border-radius: 8px;
            font-size: 0.875rem; /* text-sm */
            line-height: 1.25rem;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.06);
            border: 1px solid #D1D5DB;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
            cursor: pointer;
        }
        .filter-input:focus {
            outline: none;
            border-color: #60A5FA; /* blue-400 */
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.5); /* ring-blue-300 */
        }
        .dark .filter-input {
            background-color: #2c2c2c;
            color: #E5E5E5;
            border-color: #444;
        }
    </style>
</head>
<body class="bg-gray-50 transition-colors duration-500">

    <div id="app" class="min-h-screen">

        <header class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-4 md:p-6 shadow-lg sticky top-0 z-20">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center max-w-7xl mx-auto">
                <h1 class="text-xl md:text-2xl font-extrabold mb-2 md:mb-0">
                    GST Analytics: Defmacro Software Pvt. Ltd.
                </h1>
                <div class="flex flex-wrap items-center space-x-4 space-y-2 md:space-y-0 mt-2 md:mt-0">
                    
                    <div class="flex items-center text-sm">
                        <label for="from-date" class="font-medium mr-2">From:</label>
                        <input type="date" id="from-date" class="filter-input text-gray-800 dark:text-gray-100 dark:bg-gray-700/50" value="2023-04-01">
                        
                        <label for="to-date" class="font-medium ml-4 mr-2">To:</label>
                        <input type="date" id="to-date" class="filter-input text-gray-800 dark:text-gray-100 dark:bg-gray-700/50" value="2024-03-31">
                    </div>

                    <button id="alert-btn" class="relative p-2 rounded-full hover:bg-white/10 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.476 6.136 6 8.447 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0a2 2 0 100 4 2 2 0 000-4zm-6 0a2 2 0 100 4 2 2 0 000-4z"></path></svg>
                        <span id="alert-badge" class="absolute top-1 right-1 h-3 w-3 rounded-full bg-red-500 text-white text-xs font-bold flex items-center justify-center opacity-0 transition-opacity"></span>
                    </button>
                    <button id="theme-toggle" class="p-2 rounded-full hover:bg-white/10 transition-colors">
                        <svg id="sun-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                        <svg id="moon-icon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                    </button>
                    <select id="gstin-select" class="filter-input text-gray-800 dark:text-gray-100 dark:bg-gray-700/50">
                        </select>
                </div>
            </div>
        </header>

        <nav class="bg-white shadow-md border-b border-gray-200 sticky top-[76px] md:top-[88px] z-10 transition-colors duration-500">
            <div id="tabs-container" class="flex max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 overflow-x-auto">
                </div>
        </nav>

        <main id="main-content" class="p-4 md:p-8 max-w-7xl mx-auto w-full">
            
            <section id="overview" class="tab-content">
                <div class="mb-10">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2 transition-colors duration-500">Key Financial Metrics</h2>
                    <p id="overview-period" class="text-lg font-semibold text-blue-600 mb-4">Displaying data for the period: April 1, 2023 - March 31, 2024</p>
                    <p class="text-gray-600 mb-6 transition-colors duration-500">This summary reflects the cumulative effect of the global date and GSTIN filters.</p>
                    <div id="kpi-cards-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                        </div>
                </div>
                
                <div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2 transition-colors duration-500">Yearly Comparison: Turnover, Purchases & Margin</h2>
                    <p class="text-gray-600 mb-6 transition-colors duration-500">Monthly trends in sales and procurement, with gross margin evolution.</p>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white p-4 md:p-6 rounded-xl shadow-lg transition-colors duration-500">
                            <h3 class="font-bold text-center text-gray-700 mb-4 transition-colors duration-500">Turnover vs Purchases</h3>
                            <div class="chart-container">
                                <canvas id="turnoverChart"></canvas>
                            </div>
                        </div>
                        <div class="bg-white p-4 md:p-6 rounded-xl shadow-lg transition-colors duration-500">
                            <h3 class="font-bold text-center text-gray-700 mb-4 transition-colors duration-500">Gross Margin % Trend</h3>
                            <div class="chart-container">
                                <canvas id="marginChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="trends" class="tab-content hidden">
                <div class="mb-10">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2 transition-colors duration-500">GST Liability vs. ITC Trend</h2>
                    <p class="text-lg font-semibold text-blue-600 mb-4" id="trends-period">Displaying data for the period: April 1, 2023 - March 31, 2024</p>
                    <p class="text-gray-600 mb-6 transition-colors duration-500">This chart illustrates the monthly relationship between GST liability and the Input Tax Credit (ITC) available.</p>
                    <div class="bg-white p-4 md:p-6 rounded-xl shadow-lg transition-colors duration-500">
                        <div class="chart-container">
                            <canvas id="gstTrendChart"></canvas>
                        </div>
                    </div>
                </div>

                <div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2 transition-colors duration-500">Compliance Scorecard</h2>
                    <p class="text-gray-600 mb-6 transition-colors duration-500">A summary of filing discipline and tax payment behavior for the selected period.</p>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-yellow-500 transition-colors duration-500">
                            <h3 class="text-md font-medium text-gray-500 mb-2 transition-colors duration-500">GSTR-1 Delayed Filings</h3>
                            <div class="text-4xl font-extrabold text-gray-900 mb-2 transition-colors duration-500" id="stat-delayed-filings">4</div>
                            <div class="font-semibold kpi-trend-negative">▼ Out of 12 periods</div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-green-500 transition-colors duration-500">
                            <h3 class="text-md font-medium text-gray-500 mb-2 transition-colors duration-500">GSTR-3B Not Filed</h3>
                            <div class="text-4xl font-extrabold text-gray-900 mb-2 transition-colors duration-500" id="stat-not-filed">0</div>
                            <div class="font-semibold kpi-trend-positive">▲ 100% Compliant</div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-blue-500 transition-colors duration-500">
                            <h3 class="text-md font-medium text-gray-500 mb-2 transition-colors duration-500">Total Tax Paid in Cash</h3>
                            <div class="text-3xl font-extrabold text-gray-900 mb-2 transition-colors duration-500" id="stat-cash-paid">₹ 14.28 Cr</div>
                            <div class="text-gray-500 text-sm transition-colors duration-500">Tax Paid via ITC is ₹ 20.3 Cr</div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="parties" class="tab-content hidden">
                <div class="mb-10">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2 transition-colors duration-500">Top Customers & Suppliers</h2>
                    <p class="text-lg font-semibold text-blue-600 mb-4" id="parties-period">Displaying data for the period: April 1, 2023 - March 31, 2024</p>
                    <p class="text-gray-600 mb-6 transition-colors duration-500">Key business partners filtered by the selected criteria.</p>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-lg overflow-x-auto transition-colors duration-500">
                            <h3 class="text-xl font-semibold text-gray-700 mb-4 transition-colors duration-500">Top Customers (by Supply Value)</h3>
                            <table id="customer-table" class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-blue-50 transition-colors duration-500">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-blue-600 uppercase tracking-wider transition-colors duration-500">Name</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-blue-600 uppercase tracking-wider transition-colors duration-500">Supply Value (₹)</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-blue-600 uppercase tracking-wider transition-colors duration-500">Risk Status</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200 transition-colors duration-500">
                                    <tr class="cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors" data-type="customer" data-id="1" data-risk="regular">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 transition-colors duration-500">Times Internet Ltd.</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-700 transition-colors duration-500">2,37,87,044</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600 font-semibold">Regular</td>
                                    </tr>
                                    <tr class="cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors" data-type="customer" data-id="2" data-risk="regular">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 transition-colors duration-500">V MART RETAIL LTD</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-700 transition-colors duration-500">2,22,18,350</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600 font-semibold">Regular</td>
                                    </tr>
                                    <tr class="cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors" data-type="customer" data-id="3" data-risk="irregular">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 transition-colors duration-500">NATIONAL HOUSING BANK</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-700 transition-colors duration-500">1,81,55,560</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600 font-semibold">Irregular</td>
                                    </tr>
                                    <tr class="cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors" data-type="customer" data-id="4" data-risk="regular">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 transition-colors duration-500">TATA COFFEE LIMITED</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-700 transition-colors duration-500">1,13,05,100</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600 font-semibold">Regular</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-lg overflow-x-auto transition-colors duration-500">
                            <h3 class="text-xl font-semibold text-gray-700 mb-4 transition-colors duration-500">Top Suppliers (by Purchase Value)</h3>
                            <table id="supplier-table" class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-blue-50 transition-colors duration-500">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-blue-600 uppercase tracking-wider transition-colors duration-500">Name</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-blue-600 uppercase tracking-wider transition-colors duration-500">Purchase Value (₹)</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-blue-600 uppercase tracking-wider transition-colors duration-500">Risk Status</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200 transition-colors duration-500">
                                    <tr class="cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors" data-type="supplier" data-id="1" data-risk="regular">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 transition-colors duration-500">INEXUS BIOTECH</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-700 transition-colors duration-500">2,31,28,200</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600 font-semibold">Regular</td>
                                    </tr>
                                    <tr class="cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors" data-type="supplier" data-id="2" data-risk="regular">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 transition-colors duration-500">Calpro Specialties</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-700 transition-colors duration-500">1,98,55,980</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600 font-semibold">Regular</td>
                                    </tr>
                                    <tr class="cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors" data-type="supplier" data-id="3" data-risk="irregular">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 transition-colors duration-500">BIMAL AUTO AGENCY</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-700 transition-colors duration-500">1,55,80,000</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600 font-semibold">Irregular</td>
                                    </tr>
                                    <tr class="cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors" data-type="supplier" data-id="4" data-risk="regular">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 transition-colors duration-500">TATA CONSULTANCY SVS</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-700 transition-colors duration-500">1,45,30,000</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600 font-semibold">Regular</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2 transition-colors duration-500">State-Wise Distribution</h2>
                    <p class="text-gray-600 mb-6 transition-colors duration-500">This visual breakdown shows the geographic concentration of sales and purchases.</p>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white p-4 md:p-6 rounded-xl shadow-lg transition-colors duration-500">
                            <h3 class="font-bold text-center text-gray-700 mb-4 transition-colors duration-500">State-Wise Sales</h3>
                            <div class="chart-container">
                                <canvas id="salesStateChart"></canvas>
                            </div>
                        </div>
                        <div class="bg-white p-4 md:p-6 rounded-xl shadow-lg transition-colors duration-500">
                            <h3 class="font-bold text-center text-gray-700 mb-4 transition-colors duration-500">State-Wise Purchases</h3>
                            <div class="chart-container">
                                <canvas id="purchaseStateChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="hsn" class="tab-content hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-2 transition-colors duration-500">HSN/SAC Code Analysis</h2>
                <p class="text-lg font-semibold text-blue-600 mb-4" id="hsn-period">Displaying data for the period: April 1, 2023 - March 31, 2024</p>
                <p class="text-gray-600 mb-6 transition-colors duration-500">This section breaks down business activity and tax liability by goods (HSN) and services (SAC) codes.</p>
                
                <div class="bg-white p-6 rounded-xl shadow-lg overflow-x-auto transition-colors duration-500">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Top 5 HSN/SAC Codes by Turnover</h3>
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-blue-50 transition-colors duration-500">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-blue-600 uppercase tracking-wider">HSN/SAC</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-blue-600 uppercase tracking-wider">Description (Example)</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-blue-600 uppercase tracking-wider">Total Turnover (₹)</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-blue-600 uppercase tracking-wider">Total Tax (₹)</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <tr><td class="px-6 py-4 text-sm font-mono">998313</td><td class="px-6 py-4 text-sm">IT Consulting and Support Services</td><td class="px-6 py-4 text-sm text-right">3,50,00,000</td><td class="px-6 py-4 text-sm text-right">63,00,000</td></tr>
                            <tr><td class="px-6 py-4 text-sm font-mono">8471</td><td class="px-6 py-4 text-sm">Computer Hardware & Peripherals</td><td class="px-6 py-4 text-sm text-right">2,10,00,000</td><td class="px-6 py-4 text-sm text-right">37,80,000</td></tr>
                            <tr><td class="px-6 py-4 text-sm font-mono">9991</td><td class="px-6 py-4 text-sm">Software Development Services</td><td class="px-6 py-4 text-sm text-right">1,50,00,000</td><td class="px-6 py-4 text-sm text-right">27,00,000</td></tr>
                            <tr><td class="px-6 py-4 text-sm font-mono">3004</td><td class="px-6 py-4 text-sm">Pharmaceutical Products</td><td class="px-6 py-4 text-sm text-right">90,00,000</td><td class="px-6 py-4 text-sm text-right">10,80,000</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>
            
            <section id="rate" class="tab-content hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-2 transition-colors duration-500">GST Rate-Wise Tax Analysis</h2>
                <p class="text-lg font-semibold text-blue-600 mb-4" id="rate-period">Displaying data for the period: April 1, 2023 - March 31, 2024</p>
                <p class="text-gray-600 mb-6 transition-colors duration-500">Breakdown of total tax collected and paid across different GST tax rate slabs.</p>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-4 md:p-6 rounded-xl shadow-lg transition-colors duration-500">
                        <h3 class="font-bold text-center text-gray-700 mb-4">Sales/Output Tax by Rate</h3>
                        <div class="chart-container">
                            <canvas id="salesRateChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white p-4 md:p-6 rounded-xl shadow-lg transition-colors duration-500">
                        <h3 class="font-bold text-center text-gray-700 mb-4">Purchases/ITC by Rate</h3>
                        <div class="chart-container">
                            <canvas id="purchaseRateChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>
            
            <section id="cdn" class="tab-content hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-2 transition-colors duration-500">Credit/Debit Note Register</h2>
                <p class="text-lg font-semibold text-blue-600 mb-4" id="cdn-period">Displaying data for the period: April 1, 2023 - March 31, 2024</p>
                <p class="text-gray-600 mb-6 transition-colors duration-500">A register of all adjustments (reductions/increases) to tax liability via Credit Notes (Sales/Output) and Debit Notes (Purchases/ITC).</p>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-lg overflow-x-auto transition-colors duration-500">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4">Credit Notes (Sales Adjustments)</h3>
                        <p class="text-3xl font-extrabold text-gray-900 mb-2 text-red-600">₹ 8.5 Lac</p>
                        <p class="text-gray-500 text-sm mb-4">Total reduction in Sales Tax Liability across 12 customers.</p>
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-blue-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-blue-600 uppercase">Customer</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-blue-600 uppercase">CN Value (₹)</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <tr><td class="px-4 py-3 text-sm">V MART RETAIL LTD</td><td class="px-4 py-3 text-sm text-right">3,00,000</td></tr>
                                <tr><td class="px-4 py-3 text-sm">Times Internet Ltd.</td><td class="px-4 py-3 text-sm text-right">2,50,000</td></tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="bg-white p-6 rounded-xl shadow-lg overflow-x-auto transition-colors duration-500">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4">Debit Notes (Purchase Adjustments)</h3>
                        <p class="text-3xl font-extrabold text-gray-900 mb-2 text-green-600">₹ 10.2 Lac</p>
                        <p class="text-gray-500 text-sm mb-4">Total increase in ITC claimed from 7 suppliers.</p>
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-blue-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-blue-600 uppercase">Supplier</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-blue-600 uppercase">DN Value (₹)</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <tr><td class="px-4 py-3 text-sm">INEXUS BIOTECH</td><td class="px-4 py-3 text-sm text-right">5,20,000</td></tr>
                                <tr><td class="px-4 py-3 text-sm">Calpro Specialties</td><td class="px-4 py-3 text-sm text-right">3,00,000</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>


        </main>

        <div id="modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4 hidden modal-enter">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-lg p-6 transition-colors duration-500">
                <div class="flex justify-between items-start mb-4">
                    <h3 id="modal-title" class="text-xl font-bold text-gray-800 dark:text-gray-100 transition-colors duration-500"></h3>
                    <button id="modal-close-btn" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <p id="modal-message" class="text-gray-600 dark:text-gray-400 mb-6 transition-colors duration-500"></p>
                <div id="modal-content-details" class="space-y-4 text-gray-700 dark:text-gray-300 transition-colors duration-500">
                    </div>
                <div class="flex justify-end mt-6">
                    <button id="modal-ok-btn" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 shadow-md transition-colors duration-300">
                        Got It
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- DATA STORE ---
            const DB = {
                GSTINs: [
                    { value: "29AAFCD5862R1ZR", label: "29AAFCD5862R1ZR (Primary)" },
                    { value: "33AAFCD5862R1Z2", label: "33AAFCD5862R1Z2 (Tamil Nadu)" },
                    { value: "07AAFCD5862R1ZX", label: "07AAFCD5862R1ZX (Delhi)" },
                ],
                // UPDATED TABS LIST
                tabs: [
                    { key: "overview", label: "Financial Overview" },
                    { key: "trends", label: "Month-Wise Trends" },
                    { key: "parties", label: "Customer & Supplier Analysis" },
                    { key: "hsn", label: "HSN/SAC Analysis" },      // NEW
                    { key: "rate", label: "GST Rate Analysis" },    // NEW
                    { key: "cdn", label: "Credit/Debit Notes" }, // NEW
                ],
                financialData: {
                    "Net Turnover": { fy24: 804377766, fy23: 583693227, format: "currency" },
                    "Gross Margin %": { fy24: -0.002722, fy23: 0.007075, format: "percent" },
                    "Total ITC Claimed (FY 24)": { fy24: 9398457.81, fy23: 7518766.25, format: "currency" },
                    "Total Suppliers": { fy24: 110, fy23: 84, format: "number" },
                },
                monthlyData: {
                    labels: ['Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec', 'Jan', 'Feb', 'Mar'],
                    turnover: [7.8, 6.5, 8.2, 7.5, 9.0, 8.5, 9.8, 10.5, 11.0, 11.5, 12.0, 12.5], // Cr
                    purchases: [5.5, 4.8, 6.1, 5.2, 6.8, 6.3, 7.2, 7.8, 8.3, 8.8, 9.2, 9.5], // Cr
                    margin: [-0.3, 0.5, 0.2, -0.1, 0.8, 0.6, 0.9, 1.1, 1.2, 1.5, 1.3, 1.6], // %
                    gstLiability: [1.4, 1.2, 1.5, 1.3, 1.6, 1.5, 1.8, 1.9, 2.0, 2.1, 2.2, 2.3], // Cr
                    itcAvailable: [1.1, 0.9, 1.2, 1.0, 1.3, 1.2, 1.4, 1.5, 1.6, 1.7, 1.7, 1.8] // Cr
                },
                stateData: {
                    sales: { labels: ['Karnataka', 'Tamil Nadu', 'Delhi', 'Maharashtra', 'Other'], data: [40, 25, 15, 10, 10] },
                    purchases: { labels: ['Karnataka', 'Delhi', 'Gujarat', 'Tamil Nadu', 'Other'], data: [35, 20, 18, 12, 15] }
                },
                // Data for new GST Rate charts
                rateData: {
                    salesRates: { labels: ['18%', '12%', '5%', '28%'], data: [55, 25, 15, 5] },
                    purchaseRates: { labels: ['18%', '12%', '5%', '0%'], data: [45, 30, 20, 5] },
                },
                alerts: [
                    { message: "GSTR-1 filing deadline is in 5 days (Apr period)", type: "warning" },
                    { message: "4 GSTR-1 filings were delayed in FY 23-24. Review compliance.", type: "danger" },
                    { message: "Large purchase of ₹2.31 Cr from INEXUS BIOTECH in Q4.", type: "info" }
                ],
                customerInvoices: { 
                    'Times Internet Ltd.': [{ id: 'TI/23-24/001', date: '2023-04-10', value: '₹ 58,00,000', status: 'Paid' }],
                    'NATIONAL HOUSING BANK': [{ id: 'NHB/23-24/020', date: '2023-09-05', value: '₹ 40,00,000', status: 'Paid', status_risk: 'Irregular' }],
                    // Add more simulation data as needed
                },
                supplierInvoices: { 
                    'INEXUS BIOTECH': [{ id: 'IB/P/04-23', date: '2023-04-15', value: '₹ 45,00,000', status: 'Paid' }],
                    'BIMAL AUTO AGENCY': [{ id: 'BAA/B/05-23', date: '2023-05-18', value: '₹ 35,00,000', status: 'Paid', status_risk: 'Irregular' }],
                    // Add more simulation data as needed
                }
            };

            // --- STATE ---
            let activeTab = DB.tabs[0].key;
            let charts = {};
            let isDarkMode = localStorage.getItem('theme') === 'dark';
            
            // Get filter inputs and initial values
            const fromDateInput = document.getElementById('from-date');
            const toDateInput = document.getElementById('to-date');

            let currentFromDate = fromDateInput.value;
            let currentToDate = toDateInput.value;


            // --- HELPERS ---
            const formatCurrency = (value) => {
                const absValue = Math.abs(value);
                const sign = value < 0 ? '-' : '';
                if (absValue >= 10000000) return `${sign}₹ ${(absValue / 10000000).toFixed(2)} Cr`;
                if (absValue >= 100000) return `${sign}₹ ${(absValue / 100000).toFixed(2)} L`;
                return `${sign}₹ ${Math.round(absValue).toLocaleString("en-IN")}`;
            };

            const formatValue = (value, type) => {
                if (type === "currency") return formatCurrency(value);
                if (type === "percent") return `${(value * 100).toFixed(2)} %`;
                return value.toLocaleString("en-IN");
            };

            const calculateTrend = (current, previous, type) => {
                let trendClass, trendSymbol, trendValue, unit;
                if (type === "percent") {
                    const difference = current - previous;
                    trendValue = (Math.abs(difference) * 100).toFixed(2);
                    trendClass = difference >= 0 ? "kpi-trend-positive" : "kpi-trend-negative";
                    trendSymbol = difference >= 0 ? "▲" : "▼";
                    unit = "%pt";
                } else {
                    if (previous === 0) return '<span>-</span>';
                    const change = ((current - previous) / previous) * 100;
                    trendValue = Math.abs(change).toFixed(2);
                    trendClass = change >= 0 ? "kpi-trend-positive" : "kpi-trend-negative";
                    trendSymbol = change >= 0 ? "▲" : "▼";
                    unit = "%";
                }
                return `<span class="${trendClass} text-sm">${trendSymbol} ${trendValue} ${unit} (vs PY)</span>`;
            };

            const toggleDarkMode = () => {
                isDarkMode = !isDarkMode;
                localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
                document.documentElement.classList.toggle('dark', isDarkMode);
                document.documentElement.classList.toggle('light', !isDarkMode);

                document.getElementById('sun-icon').classList.toggle('hidden', isDarkMode);
                document.getElementById('moon-icon').classList.toggle('hidden', !isDarkMode);

                Object.values(charts).forEach(chart => {
                    chart.options.plugins.tooltip.backgroundColor = isDarkMode ? '#1a1a1a' : '#FFF';
                    chart.options.plugins.tooltip.titleColor = isDarkMode ? '#E5E5E5' : '#333';
                    chart.options.plugins.tooltip.bodyColor = isDarkMode ? '#A0A0A0' : '#555';
                    chart.update();
                });
            };
            
            const animateValue = (id, start, end, duration, formatFn, type) => {
                const range = end - start;
                const startTime = performance.now();
                const element = document.getElementById(id);

                if (!element) return;

                function step(currentTime) {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    const value = start + (range * progress);
                    element.textContent = formatFn(value, type);

                    if (progress < 1) {
                        requestAnimationFrame(step);
                    } else {
                         element.textContent = formatFn(end, type);
                    }
                }
                requestAnimationFrame(step);
            };

            const animateKPIs = () => {
                const kpiContainer = document.getElementById('kpi-cards-container');
                kpiContainer.querySelectorAll('[data-kpi-id]').forEach(card => {
                    const kpiId = card.dataset.kpiId;
                    const data = DB.financialData[kpiId];
                    const elementId = `kpi-value-${kpiId.replace(/\s/g, '-').replace(/%/g, 'percent')}`; // Sanitized ID
                    const element = document.getElementById(elementId);
                    
                    if (element) {
                        element.textContent = formatValue(0, data.format);
                        animateValue(elementId, 0, data.fy24, 1500, formatValue, data.format);
                    }
                });
            };

            const renderAlerts = () => {
                const alertBadge = document.getElementById('alert-badge');
                if (DB.alerts.length > 0) {
                    alertBadge.textContent = DB.alerts.length;
                    alertBadge.classList.remove('opacity-0');
                    alertBadge.classList.add('bg-red-500');
                } else {
                    alertBadge.classList.add('opacity-0');
                }
            };
            
            // --- RENDER FUNCTIONS (updated) ---
            const renderDropdown = () => {
                const select = document.getElementById('gstin-select');
                select.innerHTML = DB.GSTINs.map(gst => `<option value="${gst.value}">${gst.label}</option>`).join('');
            };

            const renderTabs = () => {
                const container = document.getElementById('tabs-container');
                container.innerHTML = DB.tabs.map(tab => `
                    <button data-tab="${tab.key}" class="tab-button flex items-center px-4 py-3 font-semibold text-sm transition-colors border-b-4 
                    ${tab.key === activeTab ? 'active' : 'text-gray-500 border-transparent hover:text-blue-500 hover:border-gray-300 dark:hover:border-gray-500'}">
                        ${tab.label}
                    </button>
                `).join('');
            };

            const renderKPIs = () => {
                const container = document.getElementById('kpi-cards-container');
                container.innerHTML = Object.entries(DB.financialData).map(([title, data]) => {
                    const id = title.replace(/\s/g, '-').replace(/%/g, 'percent');
                    return `
                        <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-blue-500 hover:shadow-xl transition-shadow duration-300 dark:bg-gray-800" data-kpi-id="${title}">
                            <h3 class="text-md font-medium text-gray-500 mb-2 dark:text-gray-400">${title}</h3>
                            <div id="kpi-value-${id}" class="text-3xl font-extrabold text-gray-900 mb-2 dark:text-gray-100">${formatValue(data.fy24, data.format)}</div>
                            <div class="text-sm font-semibold">
                                ${calculateTrend(data.fy24, data.fy23, data.format)}
                            </div>
                        </div>
                    `;
                }).join('');
                
                animateKPIs();
            };

            const updatePeriodLabels = (from, to) => {
                const formatter = new Intl.DateTimeFormat('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
                const formattedFrom = formatter.format(new Date(from));
                const formattedTo = formatter.format(new Date(to));
                
                const periodText = `Displaying data for the period: ${formattedFrom} - ${formattedTo}`;

                document.querySelectorAll('[id$="-period"]').forEach(el => {
                    el.textContent = periodText;
                });
            }
            
            // --- CORE FUNCTION TO UPDATE ALL DATA & CHARTS ---
            const renderData = (from, to) => {
                updatePeriodLabels(from, to);
                // In a real app, API calls would fetch data based on date and GSTIN here.
                renderKPIs();
                initCharts();
            };
            
            // --- CHART CREATION (updated with rate charts) ---
            const getChartSharedOptions = () => ({
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: window.innerWidth > 768 ? 'bottom' : 'top', labels: { color: isDarkMode ? '#A0A0A0' : '#6d7378' } },
                    tooltip: {
                        backgroundColor: isDarkMode ? '#1a1a1a' : '#FFF', titleColor: isDarkMode ? '#E5E5E5' : '#333', bodyColor: isDarkMode ? '#A0A0A0' : '#555',
                        borderColor: isDarkMode ? '#444' : '#DDD', borderWidth: 1, cornerRadius: 8, padding: 12, boxPadding: 4
                    }
                },
                scales: {
                    x: { grid: { display: false, color: isDarkMode ? '#444' : '#E5E7EB' }, ticks: { color: isDarkMode ? '#A0A0A0' : '#6d7378' } },
                    y: { 
                        grid: { color: isDarkMode ? '#444' : '#E5E7EB' }, 
                        ticks: { 
                            callback: (value) => (value >= 10 ? `${value} Cr` : value),
                            color: isDarkMode ? '#A0A0A0' : '#6d7378'
                        } 
                    }
                }
            });

            const createChart = (ctx, config) => {
                const chartId = ctx.canvas.id;
                if (charts[chartId]) {
                    charts[chartId].destroy();
                }
                charts[chartId] = new Chart(ctx, config);
            };

            const initCharts = () => {
                const sharedOptions = getChartSharedOptions();
                const chartColors = ['#3B82F6', '#F97316', '#10B981', '#8B5CF6', '#6B7280', '#EF4444'];
                const doughnutOptions = { ...sharedOptions, scales: {}, plugins: { ...sharedOptions.plugins, legend: { position: 'right', labels: { color: isDarkMode ? '#A0A0A0' : '#6d7378' } } } };

                // --- Overview Tab Charts ---
                createChart(document.getElementById('turnoverChart').getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: DB.monthlyData.labels,
                        datasets: [
                            { label: 'Net Turnover (Cr)', data: DB.monthlyData.turnover, backgroundColor: '#3B82F6', yAxisID: 'y' },
                            { label: 'Total Purchases (Cr)', data: DB.monthlyData.purchases, backgroundColor: '#F97316', yAxisID: 'y1' }
                        ]
                    },
                    options: { ...sharedOptions, scales: {
                        ...sharedOptions.scales,
                        y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Turnover (Cr)', color: isDarkMode ? '#E5E5E5' : '#333' } },
                        y1: { type: 'linear', display: true, position: 'right', grid: { drawOnChartArea: false, color: isDarkMode ? '#444' : '#E5E7EB' }, title: { display: true, text: 'Purchases (Cr)', color: isDarkMode ? '#E5E5E5' : '#333' }, ticks: { color: isDarkMode ? '#A0A0A0' : '#6d7378' } }
                    },
                    onClick: (e) => handleChartClick(e, 'turnoverChart')
                    }
                });

                createChart(document.getElementById('marginChart').getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: DB.monthlyData.labels,
                        datasets: [{ label: 'Gross Margin %', data: DB.monthlyData.margin, borderColor: '#10B981', backgroundColor: '#A7F3D0', fill: true, tension: 0.4 }]
                    },
                    options: { ...sharedOptions, scales: { 
                        ...sharedOptions.scales, 
                        y: { ticks: { callback: (value) => `${value}%`, color: isDarkMode ? '#A0A0A0' : '#6d7378' }, grid: { color: isDarkMode ? '#444' : '#E5E7EB' }, title: { display: true, text: 'Margin (%)', color: isDarkMode ? '#E5E5E5' : '#333' } } 
                    },
                    onClick: (e) => handleChartClick(e, 'marginChart')
                    }
                });

                // --- Trends Tab Chart ---
                createChart(document.getElementById('gstTrendChart').getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: DB.monthlyData.labels,
                        datasets: [
                            { label: 'GST Liability (Cr)', data: DB.monthlyData.gstLiability, borderColor: '#EF4444', tension: 0.4 },
                            { label: 'ITC Available (Cr)', data: DB.monthlyData.itcAvailable, borderColor: '#3B82F6', tension: 0.4 }
                        ]
                    },
                    options: { ...sharedOptions, scales: { 
                        ...sharedOptions.scales, 
                        y: { 
                            title: { display: true, text: 'Amount (Cr)', color: isDarkMode ? '#E5E5E5' : '#333' }, 
                            ticks: { callback: (value) => `${value} Cr`, color: isDarkMode ? '#A0A0A0' : '#6d7378' }, 
                            grid: { color: isDarkMode ? '#444' : '#E5E7EB' } 
                        } 
                    },
                    onClick: (e) => handleChartClick(e, 'gstTrendChart')
                    }
                });

                // --- Parties Tab Charts (State-Wise) ---
                createChart(document.getElementById('salesStateChart').getContext('2d'), {
                    type: 'doughnut', data: {
                        labels: DB.stateData.sales.labels,
                        datasets: [{ data: DB.stateData.sales.data, backgroundColor: chartColors, borderColor: isDarkMode ? '#1a1a1a' : '#FFF' }]
                    }, options: doughnutOptions
                });

                createChart(document.getElementById('purchaseStateChart').getContext('2d'), {
                    type: 'doughnut', data: {
                        labels: DB.stateData.purchases.labels,
                        datasets: [{ data: DB.stateData.purchases.data, backgroundColor: chartColors, borderColor: isDarkMode ? '#1a1a1a' : '#FFF' }]
                    }, options: doughnutOptions
                });

                // --- Rate Analysis Tab Charts (NEW) ---
                createChart(document.getElementById('salesRateChart').getContext('2d'), {
                    type: 'pie', data: {
                        labels: DB.rateData.salesRates.labels,
                        datasets: [{ data: DB.rateData.salesRates.data, backgroundColor: chartColors, borderColor: isDarkMode ? '#1a1a1a' : '#FFF' }]
                    }, options: doughnutOptions
                });

                createChart(document.getElementById('purchaseRateChart').getContext('2d'), {
                    type: 'pie', data: {
                        labels: DB.rateData.purchaseRates.labels,
                        datasets: [{ data: DB.rateData.purchaseRates.data, backgroundColor: chartColors, borderColor: isDarkMode ? '#1a1a1a' : '#FFF' }]
                    }, options: doughnutOptions
                });
            };
            
            // --- MODAL LOGIC (unchanged) ---
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');
            const modalContentDetails = document.getElementById('modal-content-details');

            const showModal = (title, message, contentHTML = null) => {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                modalContentDetails.innerHTML = contentHTML || '';
                modal.classList.remove('hidden');
                setTimeout(() => modal.classList.add('modal-enter-active'), 10);
            };

            const hideModal = () => {
                modal.classList.remove('modal-enter-active');
                modal.classList.add('modal-leave-active');
                setTimeout(() => {
                    modal.classList.add('hidden');
                    modal.classList.remove('modal-leave-active');
                }, 300);
            };

            const generateInvoiceTable = (invoices, isCustomer) => {
                if (!invoices || invoices.length === 0) return `<p>No recent ${isCustomer ? 'sales' : 'purchase'} invoices found under the current filter selection.</p>`;
                
                const headerValue = isCustomer ? 'Supply Value' : 'Purchase Value';
                const headerRows = `
                    <thead class="bg-blue-50 dark:bg-gray-700">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-blue-600 dark:text-blue-300 uppercase">Invoice ID</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-blue-600 dark:text-blue-300 uppercase">Date</th>
                            <th class="px-4 py-2 text-right text-xs font-medium text-blue-600 dark:text-blue-300 uppercase">${headerValue}</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-blue-600 dark:text-blue-300 uppercase">Status</th>
                        </tr>
                    </thead>
                `;

                const bodyRows = invoices.map(inv => `
                    <tr>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-gray-100">${inv.id}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">${inv.date}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-right text-gray-700 dark:text-gray-300">${inv.value}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm ${inv.status_risk === 'Irregular' ? 'text-red-600' : 'text-green-600'} dark:text-green-400">${inv.status}</td>
                    </tr>
                `).join('');

                return `
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-600">
                            ${headerRows}
                            <tbody class="bg-white divide-y divide-gray-200 dark:bg-gray-800 dark:divide-gray-600">
                                ${bodyRows}
                            </tbody>
                        </table>
                    </div>
                `;
            };

            // --- EVENT HANDLERS & LOGIC (updated) ---
            const handleTabClick = (e) => {
                const button = e.target.closest('.tab-button');
                if (!button) return;
                
                const tabKey = button.dataset.tab;
                if (tabKey === activeTab) return;

                activeTab = tabKey;
                renderTabs();
                
                document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
                document.getElementById(tabKey).classList.remove('hidden');

                // Re-render charts when switching to any tab containing a chart
                if (tabKey !== 'overview') {
                    setTimeout(() => {
                        Object.values(charts).forEach(chart => chart.resize());
                    }, 100);
                }
            };
            
            // Consolidated logic for all global filter changes (Date/GSTIN)
            const handleGlobalFilterChange = () => {
                currentFromDate = fromDateInput.value;
                currentToDate = toDateInput.value;
                const selectedGSTIN = document.getElementById('gstin-select').value;
                const gstinLabel = DB.GSTINs.find(g => g.value === selectedGSTIN).label;

                showModal(
                    "Global Data Filtering Simulation", 
                    `The dashboard is refreshing data for the period **${currentFromDate} to ${currentToDate}** and filtering by **${gstinLabel}**.`,
                    `<p class="text-sm italic">All displayed data and charts are now recalculated based on this global filter selection.</p>`
                );
                
                renderData(currentFromDate, currentToDate);
            };

            const handlePartyClick = (e) => {
                const row = e.target.closest('tr');
                if (!row) return;

                const type = row.dataset.type;
                const name = row.querySelector('td:first-child').textContent;
                const value = row.querySelector('td:nth-child(2)').textContent; // Updated to get correct column
                const riskStatus = row.dataset.risk === 'irregular' ? 'Irregular' : 'Regular';

                let title, message, invoices;

                if (type === 'customer') {
                    title = `Customer Drill-Down: ${name}`;
                    message = `Viewing last invoices for total supply value of ${value}. Risk Status: ${riskStatus}.`;
                    invoices = DB.customerInvoices[name] || DB.customerInvoices['Times Internet Ltd.']; // Fallback for demo
                } else {
                    title = `Supplier Drill-Down: ${name}`;
                    message = `Viewing last bills for total purchase value of ${value}. Risk Status: ${riskStatus}.`;
                    invoices = DB.supplierInvoices[name] || DB.supplierInvoices['INEXUS BIOTECH']; // Fallback for demo
                }
                
                const contentHTML = generateInvoiceTable(invoices, type === 'customer');
                showModal(title, message, contentHTML);
            };

            const handleChartClick = (e, chartId) => {
                const chart = charts[chartId];
                if (!chart) return;

                const activePoints = chart.getElementsAtEventForMode(e, 'nearest', { intersect: true }, false);
                if (activePoints.length === 0) return;

                const dataPoint = activePoints[0];
                const label = chart.data.labels[dataPoint.index];
                
                const title = (chartId.includes('rate') ? "Tax Rate Breakdown" : chartId.includes('Trend') ? "Monthly Transaction Breakdown" : "Data Point Detail");
                const message = `Detailed data for **${label}** applied across the current filters.`;

                const contentHTML = `<p class="text-sm italic pt-4">This modal would show a detailed list of transactions, invoices, or HSN codes contributing to the selected chart segment/month.</p>`;
                
                showModal(title, message, contentHTML);
            };

            const handleAlertClick = () => {
                const title = "Compliance & Operational Alerts";
                const message = "A list of proactive alerts requiring immediate attention.";
                
                const alertList = DB.alerts.map(alert => `
                    <div class="flex items-start p-3 rounded-lg ${alert.type === 'warning' ? 'bg-yellow-100 dark:bg-yellow-900/50 border-yellow-500' : alert.type === 'danger' ? 'bg-red-100 dark:bg-red-900/50 border-red-500' : 'bg-blue-100 dark:bg-blue-900/50 border-blue-500'} border-l-4">
                        <span class="flex-shrink-0 mr-3">${alert.type === 'warning' ? '⚠️' : alert.type === 'danger' ? '🛑' : 'ℹ️'}</span>
                        <p class="text-sm text-gray-800 dark:text-gray-100">${alert.message}</p>
                    </div>
                `).join('');

                const contentHTML = `<div class="space-y-3">${alertList}</div>`;
                showModal(title, message, contentHTML);
            };

            const debounce = (func, delay) => {
                let timeout;
                return function(...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), delay);
                };
            };
            
            // --- INITIALIZATION ---
            const init = () => {
                if (isDarkMode) {
                    document.documentElement.classList.add('dark');
                    document.getElementById('sun-icon').classList.add('hidden');
                    document.getElementById('moon-icon').classList.remove('hidden');
                } else {
                    document.documentElement.classList.add('light');
                    document.getElementById('sun-icon').classList.remove('hidden');
                    document.getElementById('moon-icon').classList.add('hidden');
                }

                renderDropdown();
                renderTabs();
                renderAlerts();
                
                renderData(currentFromDate, currentToDate);

                // Event Listeners
                document.getElementById('tabs-container').addEventListener('click', handleTabClick);
                document.getElementById('modal-close-btn').addEventListener('click', hideModal);
                document.getElementById('modal-ok-btn').addEventListener('click', hideModal);
                document.getElementById('theme-toggle').addEventListener('click', toggleDarkMode);
                document.getElementById('alert-btn').addEventListener('click', handleAlertClick);

                // Attach global filter listeners to the consolidated handler
                fromDateInput.addEventListener('change', handleGlobalFilterChange);
                toDateInput.addEventListener('change', handleGlobalFilterChange);
                document.getElementById('gstin-select').addEventListener('change', handleGlobalFilterChange);

                // Chart clicks
                document.getElementById('customer-table').addEventListener('click', handlePartyClick);
                document.getElementById('supplier-table').addEventListener('click', handlePartyClick);
                
                // Add event listeners for new charts in the Rate Analysis tab
                document.getElementById('salesRateChart').addEventListener('click', (e) => handleChartClick(e, 'salesRateChart'));
                document.getElementById('purchaseRateChart').addEventListener('click', (e) => handleChartClick(e, 'purchaseRateChart'));


                window.addEventListener('resize', debounce(() => {
                    Object.values(charts).forEach(chart => chart.resize());
                }, 200));
            };

            init();
        });
    </script>

</body>
</html>
